:DOC-CONFIG:
#+property: header-args :emacs-lisp :tangle config.el :eval never
#+property: header-args :mkdirp yes :comments no :results output silent :noweb yes
#+startup: fold
:END:
#+HTML_HEAD: <link rel="stylesheet" href="https://latex.now.sh/style.css">

This file gets tangled into [[file:config.el]], [[file:init.el]], and
[[file:packages.el]].

* References
This is not a complete list. I have read though many people's configs
and sometimes I forget to remember where I got a snippet or some
inspiration from.

- [[https:https://github.com/zzamboni/dot-doom][zzamboni's doom emacs config]]
- [[https://tecosaur.github.io/emacs-config/config.html][tecosaur's doom emacs config]]
- [[https://gitlab.com/dwt1/dotfiles/-/blob/master/.config/doom/config.org][dt's doom emacs config]]

* Config file headers
We start by simply defining the standard headers used by the three
files. These headers come from the initial files generated by
=doom install=, and contain either some Emacs-LISP relevant indicators
like =lexical-binding=, or instructions about the contents of the file.

#+begin_src emacs-lisp :tangle init.el
;;; init.el -*- lexical-binding: t; -*-

;; DO NOT EDIT THIS FILE DIRECTLY
;; This is a file generated from a literate programing source file
;; You should make any changes there and regenerate it from Emacs org-mode
;; using org-babel-tangle (C-c C-v t)

;; This file controls what Doom modules are enabled and what order they load
;; in. Remember to run 'doom sync' after modifying it!

;; NOTE Press 'SPC h d h' (or 'C-h d h' for non-vim users) to access Doom's
;;      documentation. There you'll find a "Module Index" link where you'll find
;;      a comprehensive list of Doom's modules and what flags they support.

;; NOTE Move your cursor over a module's name (or its flags) and press 'K' (or
;;      'C-c c k' for non-vim users) to view its documentation. This works on
;;      flags as well (those symbols that start with a plus).
;;
;;      Alternatively, press 'gd' (or 'C-c c d') on a module to browse its
;;      directory (for easy access to its source code).
#+end_src

#+begin_src emacs-lisp :tangle packages.el
;; -*- no-byte-compile: t; -*-
;;; $DOOMDIR/packages.el

;; DO NOT EDIT THIS FILE DIRECTLY
;; This is a file generated from a literate programing source file
;; You should make any changes there and regenerate it from Emacs org-mode
;; using org-babel-tangle (C-c C-v t)

;; To install a package with Doom you must declare them here and run 'doom sync'
;; on the command line, then restart Emacs for the changes to take effect -- or
;; use 'M-x doom/reload'.

;; To install SOME-PACKAGE from MELPA, ELPA or emacsmirror:
;;(package! some-package)

;; To install a package directly from a remote git repo, you must specify a
;; `:recipe'. You'll find documentation on what `:recipe' accepts here:
;; https://github.com/raxod502/straight.el#the-recipe-format
;;(package! another-package
;;  :recipe (:host github :repo "username/repo"))

;; If the package you are trying to install does not contain a PACKAGENAME.el
;; file, or is located in a subdirectory of the repo, you'll need to specify
;; `:files' in the `:recipe':
;;(package! this-package
;;  :recipe (:host github :repo "username/repo"
;;           :files ("some-file.el" "src/lisp/*.el")))

;; If you'd like to disable a package included with Doom, you can do so here
;; with the `:disable' property:
;;(package! builtin-package :disable t)

;; You can override the recipe of a built in package without having to specify
;; all the properties for `:recipe'. These will inherit the rest of its recipe
;; from Doom or MELPA/ELPA/Emacsmirror:
;;(package! builtin-package :recipe (:nonrecursive t))
;;(package! builtin-package-2 :recipe (:repo "myfork/package"))

;; Specify a `:branch' to install a package from a particular branch or tag.
;; This is required for some packages whose default branch isn't 'master' (which
;; our package manager can't deal with; see raxod502/straight.el#279)
;;(package! builtin-package :recipe (:branch "develop"))

;; Use `:pin' to specify a particular commit to install.
;;(package! builtin-package :pin "1a2b3c4d5e")

;; Doom's packages are pinned to a specific commit and updated from release to
;; release. The `unpin!' macro allows you to unpin single packages...
;;(unpin! pinned-package)
;; ...or multiple packages
;;(unpin! pinned-package another-pinned-package)
;; ...Or *all* packages (NOT RECOMMENDED; will likely break things)
;;(unpin! t)
#+end_src

#+begin_src emacs-lisp
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-

;; DO NOT EDIT THIS FILE DIRECTLY
;; This is a file generated from a literate programing source file
;; You should make any changes there and regenerate it from Emacs org-mode
;; using org-babel-tangle (C-c C-v t)

;; Place your private configuration here! Remember, you do not need to run 'doom
;; sync' after modifying this file!

;; Some functionality uses this to identify you, e.g. GPG configuration, email
;; clients, file templates and snippets.
;; (setq user-full-name "John Doe"
;;      user-mail-address "john@doe.com")

;; Doom exposes five (optional) variables for controlling fonts in Doom. Here
;; are the three important ones:
;;
;; + `doom-font'
;; + `doom-variable-pitch-font'
;; + `doom-big-font' -- used for `doom-big-font-mode'; use this for
;;   presentations or streaming.
;;
;; They all accept either a font-spec, font string ("Input Mono-12"), or xlfd
;; font string. You generally only need these two:
;; (setq doom-font (font-spec :family "monospace" :size 12 :weight 'semi-light)
;;       doom-variable-pitch-font (font-spec :family "sans" :size 13))

;; There are two ways to load a theme. Both assume the theme is installed and
;; available. You can either set `doom-theme' or manually load a theme with the
;; `load-theme' function. This is the default:
;; (setq doom-theme 'doom-one)

;; If you use `org' and don't want your org files in the default location below,
;; change `org-directory'. It must be set before org loads!
;; (setq org-directory "~/org/")

;; This determines the style of line numbers in effect. If set to `nil', line
;; numbers are disabled. For relative line numbers, set this to `relative'.
;; (setq display-line-numbers-type t)

;; Here are some additional functions/macros that could help you configure Doom:
;;
;; - `load!' for loading external *.el files relative to this one
;; - `use-package!' for configuring packages
;; - `after!' for running code after a package has loaded
;; - `add-load-path!' for adding directories to the `load-path', relative to
;;   this file. Emacs searches the `load-path' when you load packages with
;;   `require' or `use-package'.
;; - `map!' for binding new keys
;;
;; To get information about any of these functions/macros, move the cursor over
;; the highlighted symbol at press 'K' (non-evil users must press 'C-c c k').
;; This will open documentation for it, including demos of how they are used.
;;
;; You can also try 'gd' (or 'C-c c d') to jump to their definition and see how
;; they are implemented.
#+end_src

* Doom modules config
This is the entirety of my =init.el= file. This configures all of the
doom modules

#+begin_src emacs-lisp :tangle init.el
(doom!
#+end_src

** Input

I don't need any of these, and so I have these disabled.

#+begin_src emacs-lisp :tangle init.el
:input
;;chinese
;;japanese
;;layout
#+end_src

** Completion
#+begin_src emacs-lisp :tangle init.el
:completion
(company
 +childframe)
;;helm
;;ido
;; (ivy
;;  +icons
;;  +prescient)
(vertico
 +icons)
#+end_src

** UI

#+begin_src emacs-lisp :tangle init.el
:ui
#+end_src

I like the default emacs look a lot, so I pretty much just like to keep
it the same here.

#+begin_src emacs-lisp :tangle init.el
doom
doom-dashboard
(emoji
 +unicode
 +github)
#+end_src

These all in some way or another make code easier for me to read or make
the UI of emacs display some information that I like.

#+begin_src emacs-lisp :tangle init.el
hl-todo             ; highlight TODO/FIXME/NOTE, etc.
(ligatures
 +extra)
(modeline
 +light)
nav-flash           ; blink cursor line after big motions
(popup
 +all
 +defaults)
(vc-gutter
 +diff-hl)
workspaces
zen
#+end_src

I love how quick and easy =deft= makes it to take down a quick note that
may or may not relate to the current file This makes it much easier to
live in /emacs/ and not have to leave to another app.

#+begin_src emacs-lisp :tangle init.el
deft
#+end_src

For some reason or another I don't have each of these enabled.

#+begin_src emacs-lisp :tangle init.el
;;doom-quit
;;hydra
;;indent-guides     ; highlights indent columns
;;minimap           ; show a map of the code on the side
;;neotree           ; a project drawer, like NERDTree for vim
;;ophints
;;tabs
;;treemacs
;;unicode
;;vi-tilde-fringe
;;window-select     ; visually switch windows
#+end_src

** Editor

There isn't really much to say here, most of these are self explanatory.

#+begin_src emacs-lisp :tangle init.el
:editor
(evil +everywhere)  ; come to the dark side, we have cookies
file-templates      ; auto-snippets for empty files
fold                ; (nigh) universal code folding
(format +onsave)    ; automated prettiness
;;god               ; run Emacs commands without modifier keys
;;lispy             ; vim for emacs-lisp, for people who don't like vim
multiple-cursors    ; editing in many places at once
;;objed             ; text object editing for the innocent
;;parinfer          ; turn emacs-lisp into python, sort of
rotate-text         ; cycle region at point between text candidates
snippets            ; my elves. They type so I don't have to
word-wrap           ; soft wrapping with language-aware indent
#+end_src

** Emacs

Not much to say here other than that I use these and put them here.

#+begin_src emacs-lisp :tangle init.el
:emacs
(dired      ; making dired pretty [functional]
 +ranger
 +icons)
electric    ; smarter, keyword-based electric-indent
(ibuffer    ; interactive buffer management
 +icons)
(undo       ; persistent, smarter undo for your inevitable mistakes
 +tree)
vc          ; version-control and Emacs, sitting in a tree
#+end_src

** Term

I think vterm is the best terminal for /emacs/ and is the only one I've
liked so far.

#+begin_src emacs-lisp :tangle init.el
:term
eshell
;;shell
;;term
vterm
#+end_src

** Checkers

I tend to make a lot of silly mistakes. I couldn't imagine trying to
write anything without error checking

#+begin_src emacs-lisp :tangle init.el
:checkers
syntax
(spell
 +aspell
 +everywhere)
grammar
#+end_src

** Tools

These tools are so basic to my workflow that they can never be disabled.
These are part of the reason I use /emacs/.

#+begin_src emacs-lisp :tangle init.el
:tools
(debugger
 +lsp)
biblio
direnv
(eval
 +overlay)
gist
(lookup
 +dictionary
 +offline)
(lsp
 +peek)
magit
make
(pass
 +auth)
pdf
taskrunner
tree-sitter
#+end_src

These are just other tools that I have disabled.

#+begin_src emacs-lisp :tangle init.el
;;ansible
;;docker
;;ein
;;editorconfig      ; let someone else argue about tabs vs spaces
;;prodigy           ; FIXME managing external services & code builders
;;rgb               ; creating color strings
;;terraform         ; infrastructure as code
;;tmux              ; an API for interacting with tmux
;;upload            ; map local to remote projects via ssh/ftp
#+end_src

** OS

Exactly the same as the default emacs config.

#+begin_src emacs-lisp :tangle init.el
:os
(:if IS-MAC macos)  ; improve compatibility with macOS
;;tty               ; improve the terminal Emacs experience
#+end_src

** Lang

I write code in many different languages, both because of school and
because I like to. When I code, I usually prefer to have a language
server, and so this section ends up making my config pretty heavy
overall. I very often come here and enable or disable a language.

#+begin_src emacs-lisp :tangle init.el
:lang
;;agda              ; types of types of types of types...
;;beancount         ; mind the GAAP
(cc
 +lsp
 +tree-sitter)      ; C > C++ == 1 might add +lsp
;;clojure           ; java with a  emacs-lisp
;;common-lisp       ; if you've seen one emacs-lisp, you've seen them all
;;coq               ; proofs-as-programs
;;crystal           ; ruby at the speed of c
;;csharp            ; unity, .NET, and mono shenanigans
data              ; config/data formats
;; (dart
;;  +flutter
;;  +lsp)           ; paint ui and not much else
;;elixir            ; erlang done right
;;elm               ; care for a cup of TEA?
emacs-lisp          ; drown in parentheses
;;erlang            ; an elegant language for a more civilized age
;;ess               ; emacs speaks statistics
;;factor
;;faust             ; dsp, but you get to keep your soul
;;fsharp            ; ML stands for Microsoft's Language
;;fstar             ; (dependent) types and (monadic) effects and Z3
;;gdscript          ; the language you waited for
;;(go +lsp)         ; the hipster dialect
(haskell
 +lsp)              ; a language that's lazier than I am
;;hy                ; readability of scheme w/ speed of python
;;idris             ; a language you can depend on
json                ; At least it ain't XML
;;(java +meghanada) ; the poster child for carpal tunnel syndrome
;;javascript        ; all(hope(abandon(ye(who(enter(here))))))
;;julia             ; a better, faster MATLAB
;;kotlin            ; a better, slicker Java(Script)
(latex
 +cdlatex)          ; writing papers in Emacs has never been so fun
;;lean              ; for folks with too much to prove
;;ledger            ; be audit you can be
lua                 ; one-based indices? one-based indices
markdown            ; writing docs for people to ignore
;;nim               ; python + emacs-lisp at the speed of c
(nix
 +tree-sitter)      ; I hereby declare "nix geht mehr!"
;;ocaml             ; an objective camel
(org
 +crypt
 +dragndrop
 +gnuplot
 +hugo
 +journal
 +noter
 +pandoc
 +passwords
 +present
 +pretty
 +roam2)            ; organize your plain life in plain text
;;php               ; perl's insecure younger brother
;;plantuml          ; diagrams for confusing people more
;;purescript        ; javascript, but functional
(python             ; beautiful is better than ugly
 +lsp
 +poetry
 +pyright
 +tree-sitter)
;; qt                  ; the 'cutest' gui framework ever
;;racket            ; a DSL for DSLs
;;raku              ; the artist formerly known as perl6
;;rest              ; Emacs as a REST client
;;rst               ; ReST in peace
;;(ruby +rails)     ; 1.step {|i| p "Ruby is #{i.even? ? 'love' : 'life'}"}
(rust
 +lsp
 +tree-sitter)      ; Fe2O3.unwrap().unwrap().unwrap().unwrap()
;;scala             ; java, but good
;;(scheme +guile)   ; a fully conniving family of emacs-lisps
(sh                 ; she sells {ba,z,fi}sh shells on the C xor
 +fish
 +tree-sitter)
;;sml
;;solidity          ; do you need a blockchain? No.
;;swift             ; who asked for emoji variables?
;;terra             ; Earth and Moon in alignment for performance.
;;web               ; the tubes
yaml                ; JSON, but readable
;;zig               ; C, but simpler
#+end_src

** Email
#+begin_src emacs-lisp :tangle init.el
:email
(mu4e
 +gmail
 +org)
;;notmuch
;;(wanderlust +gmail)
#+end_src
** App
#+begin_src emacs-lisp :tangle init.el
:app
;;calendar
;;emms
;;everywhere        ; *leave* Emacs!? You must be joking
;;irc               ; how neckbeards socialize
;;(rss +org)        ; emacs as an RSS reader
;;twitter           ; twitter client https://twitter.com/vnought
#+end_src
** Config

#+begin_src emacs-lisp :tangle init.el
:config
literate
(default
  +bindings
  +smartparens)
#+end_src

** Closing

#+begin_src emacs-lisp :tangle init.el
)
#+end_src

* General config
** ~append!~ macro
#+begin_src emacs-lisp
(cl-defmacro append! (var &rest values)
  "Append VALUES to the end of VAR, if they don't already exist in VAR."
  (declare (indent defun))
  `(dolist (value (list ,@values))
     (unless (member value ,var)
       (setf ,var (append ,var (list value))))))
#+end_src
** Temporary Fixes
*** vterm
#+begin_src emacs-lisp :tangle init.el
(after! comp
  ;; HACK Disable native-compilation for some troublesome packages
  (mapc (doom-partial #'add-to-list 'native-comp-deferred-compilation-deny-list)
        (list "/emacs-jupyter.*\\.el\\'"
              "/evil-collection-vterm\\.el\\'"
              "/vterm\\.el\\'"
              "/with-editor\\.el\\'")))
#+end_src
*** Native-comp
#+begin_src emacs-lisp :tangle init.el
(setq native-comp-deferred-compilation nil)
(after! (doom-packages straight)
  (setq straight--native-comp-available t))
#+end_src
*** =transient= and =with-editor=
#+begin_src emacs-lisp :tangle packages.el
(package! transient :pin "c2bdf7e12c530eb85476d3aef317eb2941ab9440")
(package! with-editor :pin "391e76a256aeec6b9e4cbd733088f30c677d965b")
#+end_src
** NixOS and nix-darwin setup
- Load NixOS site-lisp.
- Have =pdf-tools= use =nix-shell= to build its server.

#+begin_src emacs-lisp
(when-let ((site-start (locate-library "site-start.el")))
  (load site-start)
  (message "Loaded %s" site-start)
  (when (modulep! :tools pdf)
      (setq pdf-tools-installer-os "nixos")))
#+end_src
** My personal info
#+begin_src emacs-lisp
(setq user-full-name "Kirols Bakheat"
      user-mail-address "kbakheat@gmail.com")
#+end_src

** Undo
#+begin_src emacs-lisp
(after! undo-tree
  (map! :leader
        "o U" nil
        :desc "Undo tree" "o u" #'undo-tree-visualize)
  (setq undo-tree-auto-save-history t
        undo-tree-visualizer-diff t
        undo-tree-visualizer-timestamps t))
#+end_src
** Add my snippets
This loads up my personal yasnipptes and adds them to the ones provided by doom.
#+begin_src emacs-lisp
(defvar my/snippets-dir (expand-file-name "snippets/" doom-user-dir))
(after! yasnippet
  (add-to-list 'yas-snippet-dirs 'my/snippets-dir)
    (yas-load-directory my/snippets-dir t))
#+end_src
** Keybindings
*** Clipboard
Same as vim, unnamed register applies only to this application (Emacs). "+" register applies to the system clipboard.
#+begin_src emacs-lisp
(after! evil-collection
  (setq select-enable-clipboard nil))
#+end_src
*** Keybindings for my mac.
#+begin_src emacs-lisp
(cond (IS-MAC
       (setq mac-command-modifier       'meta
             mac-option-modifier        'meta
             mac-right-option-modifier  'alt)))
#+end_src

*** Remap eval
As much as I like /"M-x"/ to type commands, I think /"SPC ;"/ is sometimes easier to hit. Unfortunately, it uses =pp-eval-expression= instead of =execute-extended-command=. This is here to remedy that and switch the two.
#+begin_src emacs-lisp
(map! :leader
      (:desc "M-x" ";" #'execute-extended-command)
      (:desc "eval-expression" ":" #'pp-eval-expression))
#+end_src
*** Swap compile and recompile
It makes more sense to me to have =c c= for recompile and =c C= for compile since I recompile more often than I compile.
#+begin_src emacs-lisp
(map! :leader
      (:desc "Reompile" "c c" #'recompile)
      (:desc "Compile" "c C" #'compile))
#+end_src
*** =toggle-debug-on-error=
#+begin_src emacs-lisp
(defvar my/debug-on-error nil)
(defun my/toggle-debug-on-error ()
  "Toggle debug-on-error."
  (interactive)
  (setq my/debug-on-error (not my/debug-on-error))
  (setq debug-on-error my/debug-on-error)
  (setq async-debug my/debug-on-error)
  (setq org-export-async-debug my/debug-on-error)
  (message "debug-on-error is %s" my/debug-on-error))


(map! :leader
      (:desc "Debug on error" "t d" #'my/toggle-debug-on-error))
#+end_src
*** Pass
#+begin_src emacs-lisp
(map! :leader
      (:desc "Pass" "o p" #'pass))
#+end_src
*** (Un)comment lines
#+begin_src emacs-lisp
(map! :leader
       (:desc "Comment/uncomment lines" "t /" #'comment-line))
#+end_src
** Evil Bookmarks
*** Fringes
#+begin_src emacs-lisp :tangle packages.el
(package! evil-fringe-mark)
#+end_src
#+begin_src emacs-lisp
(when (modulep! :editor evil)
  (use-package! evil-fringe-mark
    :unless noninteractive
    :after evil
    :hook (after-init . global-evil-fringe-mark-mode)
    :commands (evil-fringe-mark-mode)
    :config (setq evil-fringe-mark-show-special t)
    :init
    (map!
     :leader
     :desc "Toggle fringe marks" "t`" #'evil-fringe-mark-mode
     :desc "Show marks" "o`" #'evil-show-marks)))
#+end_src
*** Persist marks
#+begin_src emacs-lisp
(when (modulep! :editor evil)
  (after! savehist
    (add-to-list 'savehist-additional-variables 'evil-markers-alist)
    (add-hook 'savehist-save-hook (lambda ()
                                    (kill-local-variable 'evil-markers-alist)
                                    (dolist (entry evil-markers-alist)
                                      (when (markerp (cdr entry))
                                        (setcdr entry (cons (file-truename (buffer-file-name (marker-buffer (cdr entry))))
                                                            (marker-position (cdr entry))))))))
    (add-hook 'savehist-mode-hook (lambda ()
                                    (setq-default evil-markers-alist evil-markers-alist)
                                    (kill-local-variable 'evil-markers-alist)
                                    (make-local-variable 'evil-markers-alist))))
  ;; Persist local marks
  (append! desktop-locals-to-save evil-markers-alist))
#+end_src

** Shell
#+begin_src emacs-lisp
(after! vterm
  (setq vterm-shell "fish"))
#+end_src
** Browser changes
*** =xwidget-webkit= keybindings
#+begin_src emacs-lisp
(defun my/xwidget-window-close ()
  "Alternative to `evil-collection-xwidget-webkit-close-tab'. This both closes the tab and closes the window"
  (interactive)
  (evil-collection-xwidget-webkit-close-tab)
  (evil-window-delete)
  (xwidget-cleanup))
(map! :map xwidget-webkit-mode-map
      "q" 'my/xwidget-window-close)
(setq browse-url-browser-function 'xwidget-webkit-browse-url)

(map! :leader
      (:desc "xwidget-webkit" "o w" #'xwidget-webkit-browse-url))
#+end_src
*** =xwwp=
#+begin_src emacs-lisp :tangle packages.el
(package! ctable)
(package! xwwp
  :recipe (:host github :repo "BlueFlo0d/xwwp" :files ("*.el" "xwwp-readability.(css|js)")))
#+end_src

#+begin_src emacs-lisp
(use-package! xwwp-full
  :commands (xwwp-section
             xwwp-follow-link
             xwwp-ace-toggle
             xwwp-history-show)
  :init (map! :map xwidget-webkit-mode-map
              :localleader
              (:desc "Jump to section"  "s" #'xwwp-section)
              (:desc "Follow link"      "l" #'xwwp-follow-link)
              (:desc "Ace"              "a" #'xwwp-ace-toggle)
              (:desc "History"          "h" #'xwwp-history-show))
  :config (use-package! ctable))
#+end_src
** Global auto revert mode
Enable =global-auto-revert-mode= in buffers like =dired=.
#+begin_src emacs-lisp
(setq global-auto-revert-non-file-buffers t)
#+end_src

** =age.el=
#+begin_src emacs-lisp :tangle packages.el
(package! age)
#+end_src

#+begin_src emacs-lisp
(defun my/age-github-keys-for (username)
  "Turn GitHub USERNAME into a list of ssh public keys."
  (let* ((res (shell-command-to-string
               (format "curl -s https://api.github.com/users/%s/keys"
                       (shell-quote-argument username))))
         (json (json-parse-string res :object-type 'alist)))
    (cl-assert (arrayp json))
    (cl-loop for alist across json
             for key = (cdr (assoc 'key alist))
             when (and (stringp key)
                       (string-match-p "^\\(ssh-rsa\\|ssh-ed25519\\) AAAA" key))
             collect key)))

(defun my/age-save-with-github-recipient (username)
  "Encrypt an age file to the public keys of GitHub USERNAME."
  (interactive "MGitHub username: ")
  (cl-letf (((symbol-value 'age-default-recipient)
             (append (if (listp age-default-recipient)
                         age-default-recipient
                       (list age-default-recipient))
                     (my/age-github-keys-for username))))
    (save-buffer)))

(my/age-github-keys-for "kero0")


(use-package! age
  :mode "\\.age\\'"
  :init (age-file-enable)
  :config (setq age-default-identity "~/.ssh/id_ed25519.pub"
                age-encrypt-to '(my/age-github-keys-for "kero0")))
#+end_src
** Auto save my files
#+begin_src emacs-lisp
(setq auto-save-default t
      make-backup-files t)
#+end_src

** UI
#+begin_src emacs-lisp
(setq
 display-line-numbers-type 'relative
 which-key-idle-delay 1)
#+end_src

*** Modeline
#+begin_src emacs-lisp
(unless
    (equal
     "Battery status not available"
     (battery))
  (display-battery-mode 1)
  (setq battery-mode-line-format "[%b%p%% %t]"))
(setq doom-modeline-continuous-word-count-modes '(markdown-mode gfm-mode org-mode))
#+end_src
*** Themes
#+begin_src emacs-lisp
(solaire-global-mode +1)
(map! :leader
      :desc "Load new theme" "h t" #'load-theme)
#+end_src
**** Modus Themes
#+begin_src emacs-lisp
(setq
 modus-themes-italic-constructs t
 modus-themes-bold-constructs t
 modus-themes-subtle-line-numbers nil
 modus-themes-tabs-accented t
 modus-themes-variable-pitch-ui t
 modus-themes-inhibit-reload t ; only applies to `customize-set-variable' and related

 ;; Options for `modus-themes-prompts' are either nil (the
 ;; default), or a list of properties that may include any of those
 ;; symbols: `background', `bold', `gray', `intense', `italic'
 modus-themes-prompts '(background bold intense italic)

 ;; The `modus-themes-completions' is an alist that reads three
 ;; keys: `matches', `selection', `popup'.  Each accepts a nil
 ;; value (or empty list) or a list of properties that can include
 ;; any of the following (for WEIGHT read further below):
 ;;
 ;; `matches' - `background', `intense', `underline', `italic', WEIGHT
 ;; `selection' - `accented', `intense', `underline', `italic', `text-also', WEIGHT
 ;; `popup' - same as `selected'
 ;; `t' - applies to any key not explicitly referenced (check docs)
 ;;
 ;; WEIGHT is a symbol such as `semibold', `light', or anything
 ;; covered in `modus-themes-weights'.  Bold is used in the absence
 ;; of an explicit WEIGHT.
 modus-themes-completions
 '((matches . (semibold))
   (selection . (extrabold accented))
   (popup . (extrabold accented)))

 modus-themes-org-blocks 'tinted-background ; {nil,'gray-background,'tinted-background}

 ;; The `modus-themes-headings' is an alist with lots of possible
 ;; combinations, include per-heading-level tweaks: read the
 ;; manual or its doc string
 modus-themes-headings
 '((0 . (variable-pitch light (height 2.2)))
   (1 . (rainbow variable-pitch light (height 1.6)))
   (2 . (rainbow variable-pitch light (height 1.4)))
   (3 . (rainbow variable-pitch regular (height 1.3)))
   (4 . (rainbow regular (height 1.2)))
   (5 . (rainbow (height 1.1)))
   (t . (variable-pitch extrabold))))

(setq modus-themes-italic-constructs t
      modus-themes-bold-constructs t
      modus-themes-mixed-fonts t
      modus-themes-variable-pitch-ui t
      modus-themes-custom-auto-reload nil
      modus-themes-disable-other-themes t

      ;; Options for `modus-themes-prompts' are either nil (the
      ;; default), or a list of properties that may include any of those
      ;; symbols: `italic', `WEIGHT'
      modus-themes-prompts '(italic bold)

      ;; The `modus-themes-completions' is an alist that reads two
      ;; keys: `matches', `selection'.  Each accepts a nil value (or
      ;; empty list) or a list of properties that can include any of
      ;; the following (for WEIGHT read further below):
      ;;
      ;; `matches'   :: `underline', `italic', `WEIGHT'
      ;; `selection' :: `underline', `italic', `WEIGHT'
      modus-themes-completions
      '((matches . (semibold))
        (selection . (extrabold accented)))

      modus-themes-org-blocks 'tinted-background ; {nil,'gray-background,'tinted-background}

      ;; The `modus-themes-headings' is an alist: read the manual's
      ;; node about it or its doc string.  Basically, it supports
      ;; per-level configurations for the optional use of
      ;; `variable-pitch' typography, a height value as a multiple of
      ;; the base font size (e.g. 1.5), and a `WEIGHT'.
      modus-themes-headings
      '((1 . (variable-pitch 1.5))
        (2 . (1.3))
        (agenda-date . (1.3))
        (agenda-structure . (variable-pitch light 1.8))
        (t . (1.1))))

#+end_src
**** Theme switching
#+begin_src emacs-lisp
(setq doom-theme 'modus-operandi-tinted
      modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi-tinted))
(map! :leader
      :desc "Modus theme" "t t" #'modus-themes-toggle)
#+end_src
*** Fonts
Setting fonts and some emojis.

#+begin_src emacs-lisp
(use-package! mixed-pitch
  :hook (org-mode . mixed-pitch-mode)
  :config (setq mixed-pitch-face 'variable-pitch))
(use-package! emojify
  :hook (after-init . global-emojify-mode))

(setq doom-font                (font-spec :family "JetBrainsMono Nerd Font Mono" :size 18.0)
      doom-variable-pitch-font (font-spec :family "JetBrainsMono Nerd Font" :size 18.0)
      doom-unicode-font        (font-spec :family "JuliaMono" :size 18.0)
      doom-big-font            (font-spec :family "JetBrainsMono Nerd Font" :size 23.0))
(after! doom-themes
  (setq doom-themes-enable-bold t
        doom-themes-enable-italic t))
(use-package! doom-themes)
(custom-set-faces!
  '(font-lock-comment-face :slant italic)
  '(font-lock-keyword-face :slant italic))
#+end_src

** LSP
#+begin_src emacs-lisp
;; (when (and (modulep! :tools lsp +eglot) (modulep! :checkers syntax))
;;   (delq! 'eglot flycheck-checkers))

(after! lsp
  (when (and (modulep! :tools lsp) (not (modulep! :tools lsp +eglot)))
    (setq
     gc-cons-threshold (* 100 1000 1000) ;; 100mb
     read-process-output-max (* 3 1024 1024) ;; 3mb

     lsp-completion-enable t
     lsp-enable-snippet t
     lsp-enable-folding t
     lsp-enable-indentation t
     lsp-enable-file-watchers t
     lsp-enable-on-type-formatting nil
     lsp-enable-relative-indentation t
     lsp-enable-semantic-highlighting nil)))
#+end_src

*** Rust
#+begin_src emacs-lisp
(after! rustic
  (map! :map rustic-mode-map
        :localleader
        (:desc "Cargo run" "r" #'lsp-rust-analyzer-run)
        (:desc "Expand macro" "m" #'lsp-rust-analyzer-expand-macro))
  (setq lsp-rust-analyzer-display-chaining-hints t
        lsp-rust-analyzer-display-parameter-hints t
        lsp-rust-analyzer-display-lifetime-elision-hints-enable "skip_trivial"
        lsp-rust-analyzer-display-lifetime-elision-hints-use-parameter-names t
        lsp-rust-analyzer-display-closure-return-type-hints t
        lsp-rust-analyzer-display-reborrow-hints t))
#+end_src

*** LSP in org-mode code blocks
Copied from tecosaur's config.
#+begin_src emacs-lisp
(cl-defmacro lsp-org-babel-enable (lang)
  "Support LANG in org source code block."
  (setq centaur-lsp 'lsp-mode)
  (cl-check-type lang stringp)
  (let* ((edit-pre (intern (format "org-babel-edit-prep:%s" lang)))
         (intern-pre (intern (format "lsp--%s" (symbol-name edit-pre)))))
    `(progn
       (defun ,intern-pre (info)
         (let ((file-name (->> info caddr (alist-get :file))))
           (unless file-name
             (setq file-name (make-temp-file "babel-lsp-")))
           (setq buffer-file-name file-name)
           (lsp-deferred)))
       (put ',intern-pre 'function-documentation
            (format "Enable lsp-mode in the buffer of org source block (%s)."
                    (upcase ,lang)))
       (if (fboundp ',edit-pre)
           (advice-add ',edit-pre :after ',intern-pre)
         (progn
           (defun ,edit-pre (info)
             (,intern-pre info))
           (put ',edit-pre 'function-documentation
                (format "Prepare local buffer environment for org source block (%s)."
                        (upcase ,lang))))))))
(defvar org-babel-lang-list
  '("python" "ipython" "bash" "sh" "haskell"))
(dolist (lang org-babel-lang-list)
  (eval `(lsp-org-babel-enable ,lang)))
#+end_src
** DAP
*** Rust
#+begin_src emacs-lisp
(after! lsp-rust
  (setq lsp-rust-analyzer-debug-lens-extra-dap-args
        `(:MIMode "lldb"
          :miDebuggerPath ,(f-join doom-local-dir "etc/dap-extension/vscode/cpptools/extension/debugAdapters/lldb-mi/bin/lldb-mi")
          :stopAtEntry t
          :externalConsole
          :json-false)))
;; (after! dap-cpptools
;;   (dap-register-debug-template "Rust::CppTools Run Configuration"
;;                                `(:type "cppdbg"
;;                                  :request "launch"
;;                                  :name "Rust::Run ${workspaceFolderBasename}"
;;                                  :MIMode "lldb"
;;                                  :miDebuggerPath ,(f-join doom-local-dir "etc/dap-extension/vscode/cpptools/extension/debugAdapters/lldb-mi/bin/lldb-mi")
;;                                  :environment []
;;                                  :program "${workspaceFolder}/target/debug/${workspaceRootFolderBasename}"
;;                                  :args []
;;                                  :cwd "${workspaceFolder}"
;;                                  :console "external"
;;                                  :dap-compilation "cargo build"
;;                                  :dap-compilation-dir "${workspaceFolder}")))

#+end_src
*** Keybindings
Trying out DAP for my debugger
#+begin_src emacs-lisp
(after! dap-mode
  (setq dap-python-debugger 'debugpy))

(map! :map dap-mode-map
      :leader
      :prefix ("d" . "dap")
      ;; basics
      :desc "dap next"          "n" #'dap-next
      :desc "dap step in"       "i" #'dap-step-in
      :desc "dap step out"      "o" #'dap-step-out
      :desc "dap continue"      "c" #'dap-continue
      :desc "dap hydra"         "h" #'dap-hydra
      :desc "dap debug restart" "r" #'dap-debug-restart
      :desc "dap quit"          "q" #'+debugger/quit

      ;; debug
      :prefix ("dd" . "Debug")
      :desc "dap debug recent"  "r" #'dap-debug-recent
      :desc "dap debug last"    "l" #'dap-debug-last
      :desc "dap debug"         "s" #'dap-debug

      ;; eval
      :prefix ("de" . "Eval")
      :desc "eval"                "e" #'dap-eval
      :desc "eval region"         "r" #'dap-eval-region
      :desc "eval thing at point" "s" #'dap-eval-thing-at-point
      :desc "add expression"      "a" #'dap-ui-expressions-add
      :desc "remove expression"   "d" #'dap-ui-expressions-remove

      :prefix ("db" . "Breakpoint")
      :desc "dap breakpoint toggle"      "b" #'dap-breakpoint-toggle
      :desc "dap breakpoint condition"   "c" #'dap-breakpoint-condition
      :desc "dap breakpoint hit count"   "h" #'dap-breakpoint-hit-condition
      :desc "dap breakpoint log message" "l" #'dap-breakpoint-log-message)
#+end_src
** Email
To get my [[*Detroit Mercy email]] to work, I am actually using a patched version of =isync=. I added these patches to the brewfile for =isync=.
*** Setup
:PROPERTIES:
:header-args: :sh :tangle no :eval never
:END:
Install deps on a mac.
#+begin_src sh :eval never
brew install isync msmtp mu openssl@1.1
#+end_src

Setup =mu=.
#+begin_src sh :eval never
mkdir -p ~/.local/mail/{kbakheat-gmail, kirolsb5-gmail, bakheakm-udmercy}
mbsync -a -c ~/.mbsyncrc && \
mu init \
  --maildir ~/.local/mail/ \
  --my-address kbakheat@gmail.com \
  --my-address kirolsb5@gmail.com \
  --my-address bakheakm@udmercy.edu \
  && \
mu index
#+end_src
*** Main Config

#+begin_src emacs-lisp
(after! mu4e
  (map! :map mu4e-headers-mode-map
        :localleader
        (:desc "Update and index mail"  "u" #'mu4e-update-mail-and-index)
        (:desc "View in ..."            "v" #'mu4e-view-action))
  (imagemagick-register-types)
  (defun my/mu-filter (s)
    (concat "(" s ") AND (NOT flag:trashed) AND (NOT maildir:/.*\/spam|Junk\ Email/)"))
  (defvar my/vip-emails '(
                          "pmegally@gmail.com"
                          "stmarkmi@ccbchurch.com"
                          "/.+@udmercy.edu/"
                          "/.+@ford.com/"))
  (defun my/mu-filter-vip (s)
    (mu-filter (mapconcat '(lambda (x) (concat "from:" x)) my/vip-emails " OR ")))
  (setq
   sendmail-program "msmtp"
   send-mail-function #'smtpmail-send-it
   message-sendmail-f-is-evil t
   message-sendmail-extra-arguments '("--read-envelope-from")
   message-send-mail-function #'message-send-mail-with-sendmail
   mu4e-attachment-dir "~/Downloads"
   mu4e-update-interval 300
   mu4e-use-fancy-chars t
   mu4e-change-filenames-when-moving t))
#+end_src
*** Per-Account config
**** Main gmail
#+begin_src emacs-lisp
(set-email-account! "primary"
  '((mu4e-sent-folder       . "/kbakheat-gmail/Sent Mail")
    (mu4e-drafts-folder     . "/kbakheat-gmail/Drafts")
    (mu4e-trash-folder      . "/kbakheat-gmail/Trash")
    (mu4e-refile-folder     . "/kbakheat-gmail/All Mail")
    (smtpmail-smtp-user     . "kbakheat@gmail.com")
    (mu4e-compose-signature . "---\nKirols Bakheat"))
  t)
#+end_src

**** Secondary gmail
#+begin_src emacs-lisp
(set-email-account! "secondary"
  '((mu4e-sent-folder       . "/kirolsb5-gmail/Sent Mail")
    (mu4e-drafts-folder     . "/kirolsb5-gmail/Drafts")
    (mu4e-trash-folder      . "/kirolsb5-gmail/Trash")
    (mu4e-refile-folder     . "/kirolsb5-gmail/All Mail")
    (smtpmail-smtp-user     . "kbakheat@gmail.com")
    (mu4e-compose-signature . "---\nKirols Bakheat"))
  t)
#+end_src
**** Detroit Mercy email
#+begin_src emacs-lisp
(set-email-account! "udmercy"
  '((mu4e-sent-folder       . "/bakheakm-udmercy/Sent Items")
    (mu4e-drafts-folder     . "/bakheakm-udmercy/Drafts")
    (mu4e-trash-folder      . "/bakheakm-udmercy.edu/Trash")
    (mu4e-refile-folder     . "/bakheakm-udmercy/Archive")
    (smtpmail-smtp-user     . "bakheakm@udmercy.edu")
    (mu4e-compose-signature . "---\nKirols Bakheat"))
  t)
#+end_src

** =man= and =tldr=
#+begin_src emacs-lisp :tangle packages.el
(package! tldr)
#+end_src

#+begin_src emacs-lisp
(use-package! tldr
  :commands tldr
  :config (setq tldr-directory-path (expand-file-name "tldr/" doom-data-dir)))
(map!
 :leader :prefix ("h h" . "command line help")
 :desc "man" "m" #'man
 :desc "tldr" "t" #'tldr)
#+end_src
** =biblio=
#+begin_src emacs-lisp
(defvar my/citations-dir
  (concat doom-user-dir "citations/"))

(after! org-cite
  (setq org-cite-csl-styles-dir (concat my/citations-dir "styles/")))
(after! bibtex-completion
  (setq!
   bibtex-completion-bibliography  (concat my/citations-dir "ref.bib")
   ;bibtex-completion-library-path '("/path/to/library/path/")
   ;bibtex-completion-notes-path "/path/to/your/notes/"
   ))
#+end_src
** Licenses
#+begin_src emacs-lisp :tangle packages.el
(package! lice)
#+end_src

#+begin_src emacs-lisp
(use-package! lice
  :commands lice)
(map!
 :leader
 :desc "Insert license" "i l" #'lice)
#+end_src
** =string-inflection=
I don't use this that often but it is convenient when I occasionally need it.

#+begin_src emacs-lisp :tangle packages.el
(package! string-inflection)
#+end_src
#+begin_src emacs-lisp
(use-package! string-inflection
  :commands (string-inflection-all-cycle
             string-inflection-toggle
             string-inflection-camelcase
             string-inflection-lower-camelcase
             string-inflection-kebab-case
             string-inflection-underscore
             string-inflection-capital-underscore
             string-inflection-upcase)
  :init
  (map! :leader :prefix ("c~" . "naming convention")
        :desc "cycle" "~" #'string-inflection-all-cycle
        :desc "toggle" "t" #'string-inflection-toggle
        :desc "CamelCase" "c" #'string-inflection-camelcase
        :desc "downCase" "d" #'string-inflection-lower-camelcase
        :desc "kebab-case" "k" #'string-inflection-kebab-case
        :desc "under_score" "_" #'string-inflection-underscore
        :desc "Upper_Score" "u" #'string-inflection-capital-underscore
        :desc "UP_CASE" "U" #'string-inflection-upcase)
  (after! evil
    (evil-define-operator evil-operator-string-inflection (beg end _type)
      "Define a new evil operator that cycles symbol casing."
      :move-point nil
      (interactive "<R>")
      (string-inflection-all-cycle)
      (setq evil-repeat-info '([?g ?~])))
    (define-key evil-normal-state-map (kbd "g~") 'evil-operator-string-inflection)))
    #+end_src
** Github Copilot
#+begin_src emacs-lisp :tangle packages.el
(package! copilot
  :recipe (:host github :repo "zerolfx/copilot.el" :files ("*.el" "dist")))
#+end_src

#+begin_src emacs-lisp
(use-package! copilot
  :unless noninteractive
  :hook (prog-mode . copilot-mode)
  :hook (text-mode . copilot-mode)
  :config
  (map! :map copilot-completion-map
    "C-s"       #'copilot-accept-completion
    "M-<right>" #'copilot-accept-completion-by-word
    "C-f"       #'copilot-accept-completion-by-line
    "M-n"       #'copilot-next-completion
    "M-p"       #'copilot-previous-completion
    "C-b"       #'copilot-complete))
#+end_src
** =envrc=
#+begin_src emacs-lisp :tangle packages.el
(unpin! envrc)
#+end_src
** Org mode
*** General config
#+begin_src emacs-lisp
(defun my/relative-org (dir)
  "Makes a sting representing a directory relative to my org base directory"
  (setq my-org-base-dir "~/org")
  (concat (file-name-as-directory my-org-base-dir) dir))
(setq
 org-directory (my/relative-org "general")
 deft-directory (my/relative-org "deft"))

(after! org
  (add-to-list 'org-latex-packages-alist '("" "fancyhdr"))
  (add-to-list 'org-latex-packages-alist '("" "siunitx"))
  (plist-put org-format-latex-options :scale 1)
  (setq
   org-hide-leading-stars nil
   org-insert-heading-respect-content nil
   org-export-in-background t
   org-export-with-sub-superscripts '{}
   org-list-allow-alphabetical t)
  (map! :map org-mode-map
        :localleader
        (:prefix ("SPC" . "Personal org map")))

  (setq org-clock-persist t)
  (org-clock-persistence-insinuate)

  (defun locally-defer-font-lock ()
    "Set jit-lock defer and stealth, when buffer is over a certain size."
    (when (> (buffer-size) 50000)
      (setq-local jit-lock-defer-time 0.05
                  jit-lock-stealth-time 1)))
  (add-hook 'org-mode-hook #'locally-defer-font-lock))
#+end_src
*** =org-babel= default /header-args/
#+begin_src emacs-lisp
(after! org
  (setq
   org-babel-default-header-args
   '((:results . "replace")
     (:exports . "both")
     (:cache . "yes")
     (:noweb . "yes")
     (:hlines . "no")
     (:mkdirp . "yes")
     (:tangle . "no"))))
#+end_src
*** Beautification of org-mode
**** =org= specific config
#+begin_src emacs-lisp
(after! org
  (setq
   org-auto-align-tags t
   org-tags-column 0
   org-catch-invisible-edits 'smart
   org-special-ctrl-a/e t
   org-insert-heading-respect-content t

   org-fontify-quote-and-verse-blocks t
   org-fontify-whole-heading-line t
   org-fontify-done-headline t
   org-src-fontify-natively t

   org-ellipsis " ↷"
   org-hide-emphasis-markers t
   org-pretty-entities t))
#+end_src
**** =org-agenda=
#+begin_src emacs-lisp
(after! org-agenda
  (setq
   org-agenda-tags-column 0
   org-agenda-block-separator ?─
   org-agenda-time-grid
   '((daily today require-timed)
     (800 1000 1200 1400 1600 1800 2000)
     " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄")
   org-agenda-current-time-string
   "⭠ now ─────────────────────────────────────────────────"))
#+end_src
*** Roam
#+begin_src emacs-lisp
(setq org-roam-v2-ack t)
(after! org-roam
  (setq
   org-roam-directory (my/relative-org "roam")
   org-roam-completion-everywhere t))
#+end_src
**** Templates
#+begin_src emacs-lisp
(after! org-roam
  (add-to-list 'org-roam-capture-templates
               '("r" "Templates for religious meditations"))

  (add-to-list 'org-roam-capture-templates
               '("rl" "Lesson" plain "#+filetags: lesson \"Topic: ${topic}\"\n* %?"
                 :if-new (file+head "religious/lessons/%<%Y%m%d%H%M%S>-${slug}.org"
                                    "#+title: ${title}\n\n")
                 :unnarrowed t))

  (add-to-list
   'org-roam-capture-templates
   '("rs" "Saint" plain "#+filetags: saint \"Saint Type: ${saint type}\" \"Years: ${birth year}-${death year}\" \"Country: ${country}\" \"City: ${city}\"\n\n* Birth\n%?\n\n* Life\n\n\n* Death\n\n\n* Related saints\n\n"
     :if-new (file+head "religious/saints/%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
     :unnarrowed t))
  (add-to-list
   'org-roam-capture-templates
   '("rb" "Bible Study" plain "#+filetags: \"bible study\" \"Book: ${book}\" \"Topic: ${topic}\"\n\n* Topic\n\n* Related\n** Passages\n\n** Meditations\n\n* Personal Meditation\n\n"
     :if-new (file+head "religious/bible-study/%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
     :unnarrowed t)))
#+end_src
*** Xenops
Originally had =fragtog= here but switched to =xenops= because it
doesn't interrupt my typing as bad. I don't like that this messes with other /doom/ keybindings though.

#+begin_src emacs-lisp :tangle packages.el
(package! xenops)
#+end_src

#+begin_src emacs-lisp
(use-package! xenops
  :commands (xenops-mode)
  :init (map! :map org-mode-map
              :localleader
              :desc "enable xenops" "SPC x" #'xenops-mode)
  :config (setq xenops-math-image-current-scale-factor 2.0))
#+end_src
*** Org-auto-tangle
#+begin_src emacs-lisp :tangle packages.el
(package! org-auto-tangle)
#+end_src

#+begin_src emacs-lisp
(use-package! org-auto-tangle
  :hook (org-mode . org-auto-tangle-mode)
  :config
  (setq org-auto-tangle-default t))
#+end_src
*** Lilypond
#+begin_src emacs-lisp
(use-package! lilypond-mode
  :commands LilyPond-mode
  :init (defalias 'lilypond-mode 'LilyPond-mode)
  :config
  (if IS-MAC
      (setq org-babel-lilypond-commands '("lilypond" "open" "open"))))
#+end_src
*** =ox-latex=
#+begin_src emacs-lisp
(after! ox-latex
  (add-to-list 'org-latex-logfiles-extensions "tex"))
#+end_src
**** Syntax highlighting
#+begin_src emacs-lisp :tangle packages.el
(package! engrave-faces
  :recipe (:host github :repo "tecosaur/engrave-faces"))
#+end_src

#+name: engrave-faces-init
#+begin_src emacs-lisp
(defvar-local org-export-has-code-p nil)

(defadvice! org-export-expect-no-code (&rest _)
  :before #'org-export-as
  (setq org-export-has-code-p nil))

(defadvice! org-export-register-code (&rest _)
  :after #'org-latex-src-block
  :after #'org-latex-inline-src-block-engraved
  (setq org-export-has-code-p t))

(defadvice! org-latex-example-block-engraved (orig-fn example-block contents info)
  "Like `org-latex-example-block', but supporting an engraved backend"
  :around #'org-latex-example-block
  (let ((output-block (funcall orig-fn example-block contents info)))
    (if (eq 'engraved (plist-get info :latex-listings))
        (format "\\begin{Code}[alt]\n%s\n\\end{Code}" output-block)
      output-block)))
#+end_src

#+begin_src emacs-lisp
(use-package! engrave-faces-latex
  :after ox-latex
  :init
  <<engrave-faces-init>>
  :config
  (setq org-latex-listings 'engraved))
(use-package! engrave-faces-html
  :after ox-html
  :init
  <<engrave-faces-init>>
  :config
  (setq org-latex-listings 'engraved))
#+end_src
**** =ox-chameleon=
Occasionally I want to export a file that looks like emacs. This is mostly done for presentation's sake.
#+begin_src emacs-lisp :tangle packages.el
(package! ox-chameleon
  :recipe (:host github :repo "tecosaur/ox-chameleon"))
#+end_src
#+begin_src emacs-lisp
(use-package! ox-chameleon
  :after ox
  :config
  (add-to-list 'org-latex-packages-alist '("" "scrextend" nil))
  (add-to-list 'org-latex-packages-alist '("" "xcolor" nil)))
#+end_src
**** Classes
#+begin_src emacs-lisp
(after! ox-latex
  (add-to-list 'org-latex-packages-alist '("" "siunitx"))
  (add-to-list 'org-latex-packages-alist '("" "amsmath"))
  (add-to-list 'org-latex-packages-alist '("" "fancyhdr"))
  (add-to-list 'org-latex-classes
               '("IEEEtran" "\\documentclass[11pt]{IEEEtran}"
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph{%s}" .    "\\subparagraph*{%s}")))
  (add-to-list 'org-latex-classes
               '("exam"
                 "\\documentclass{exam}"
                 ("\\begin{questions} %% %s"
                  "\\end{questions}"
                  "\\begin{questions} %% %s"
                  "\\end{questions}")
                 ("\\question %s " . "\\question* %s")
                 ("\\begin{parts} %s"
                  "\\end{parts}"
                  "\\begin{parts} %s"
                  "\\end{parts}"))))
#+end_src
*** =literate-calc-mode=
#+begin_src emacs-lisp :tangle packages.el
(package! literate-calc-mode)
#+end_src

#+begin_src emacs-lisp
(use-package! literate-calc-mode
  :commands (literate-calc-minor-mode
             literate-calc-eval-line
             literate-calc-insert-results)
  :init (map! :map org-mode-map
              :localleader
              (:prefix ("SPC c" . "literate calc")
               (:desc "Enable" "e" #'literate-calc-minor-mode)
               (:desc "Evaluate line" "c" #'literate-calc-eval-line)
               (:desc "Insert results" "i" #'literate-calc-insert-results))))
#+end_src
*** =org-tree-slide-mode=
#+begin_src emacs-lisp
(use-package! org-tree-slide
  :config
  (map! :map org-tree-slide-mode-map
        :n "M-<left>"  #'org-tree-slide-move-previous-tree
        :n "M-<right>" #'org-tree-slide-move-next-tree))
#+end_src
* Footers

#+begin_src emacs-lisp
(provide 'config)
;;; config.el ends here
#+end_src

#+begin_src emacs-lisp :tangle init.el
(provide 'init)
;;; init.el ends here
#+end_src

#+begin_src emacs-lisp :tangle packages.el
(provide 'packages)
;;; packages.el ends here
#+end_src
